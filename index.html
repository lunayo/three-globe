<head>
  <style> body { margin: 0; } </style>

  <script src="//unpkg.com/three"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
  <script src="data.js"></script>
  <script src="dist/three-globe.js"></script>
</head>

<body>
  <div id="globeViz"></div>

  <script>

    const Globe = new ThreeGlobe()
      .globeImageUrl('img/earth-blue-marble.jpg')
      .bumpImageUrl('img/earth-topology.png')
      .pointsData(data)
      .pointAltitude(0.08)
      .pointColor(() => '#ffffaa');

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
    directionalLight.position.set(1, 1, 1); // change light position to see the specularMap's effect

    // Setup renderer
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('globeViz').appendChild(renderer.domElement);

    // Setup scene
    const scene = new THREE.Scene();
    scene.add(Globe);
    scene.add(new THREE.AmbientLight(0xbbbbbb));
    scene.add(directionalLight);

    // Setup camera
    const camera = new THREE.PerspectiveCamera();
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    camera.position.z = 280;


    document.onkeydown = checkKey;
    function animatePosition(targetAngle, targetSpeed, callback) {
      let speed = { angle: 0.0 };
      let tween = new TWEEN.Tween(speed)
        .easing(TWEEN.Easing.Cubic.InOut)
        .to({ angle: targetAngle }, targetSpeed)
        .start();

      tween.onUpdate(function(){
        callback(speed.angle);
      });
    }
    function checkKey(e) {
        e = e || window.event;
        const currentPosition = { ...camera.position };
        if (e.keyCode == '38') {
            // up arrow
            animatePosition(0.03, 500, function(angle) {
              if (scene.rotation.x < -1.5) return;
              scene.rotation.x -= angle;
            });
        }
        else if (e.keyCode == '40') {
            // down arrow
            animatePosition(0.03, 500, function(angle) {
              if (scene.rotation.x > 1.5) return;
              scene.rotation.x += angle;
            });
        }
        else if (e.keyCode == '37') {
            // left arrow
            animatePosition(0.05, 500, function(angle) {
              // if (currentPosition.z * Math.cos(angle) + currentPosition.y * Math.sin(angle) < 0) return;
              scene.rotation.y -= angle;
            });
        }
        else if (e.keyCode == '39') {
            // right arrow
            animatePosition(0.05, 500, function(angle) {
              // if (currentPosition.z * Math.cos(angle) + currentPosition.y * Math.sin(angle) < 0) return;
              scene.rotation.y += angle;
            });
        }
        else if (e.keyCode == '13') {
          // enter key
      }
    }

    // Kick-off renderer
    (function animate() { // IIFE
      // Frame cycle
      TWEEN.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    })();
  </script>
</body>