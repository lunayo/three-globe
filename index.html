<head>
  <style> body { margin: 0; } </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link href="stylesheets/clock.css" rel="stylesheet">

  <script src="//unpkg.com/three"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
  <script src="https://unpkg.com/@reactivex/rxjs@5.5.11/dist/global/Rx.min.js"></script>
  <script src="https://unpkg.com/rxcss@0.6.0/dist/rxcss.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <!-- <script src="//unpkg.com/three/examples/js/controls/TrackballControls.js"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="scripts/data.js"></script>
  <script src="dist/three-globe.js"></script>
</head>

<body>
  <div class="time" id="time" data-hours="" data-minutes="">
    <div class="digit">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
    <div class="digit">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
    <div class="digit">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
    <div class="digit">
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
      <div class="line"></div>
    </div>
  </div>
  <div id="globeViz"></div>
  <div id="videoModal" class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modal title</h5>
        </div>
        <div class="modal-body">
          <div class="embed-responsive embed-responsive-16by9">
            <video controls loop style="width: 100%;height: auto;">
              <source src="" type="video/mp4"></source>
            </video>
          </div>
          <p class="description"></p>
        </div>
      </div>
    </div>
  </div>

  <script>

    const Globe = new ThreeGlobe()
      .globeImageUrl('img/earth-blue-marble.jpg')
      .bumpImageUrl('img/earth-topology.png')
      .pointsData(data)
      .pointAltitude(0.08)
      .pointColor(() => '#ffffaa');

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
    directionalLight.position.set(1, 1, 1); // change light position to see the specularMap's effect

    // Setup renderer
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('globeViz').appendChild(renderer.domElement);

    // Setup scene
    const scene = new THREE.Scene();
    scene.add(Globe);
    scene.add(new THREE.AmbientLight(0xbbbbbb));
    scene.add(directionalLight);

    // Setup camera
    const camera = new THREE.PerspectiveCamera();
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    camera.position.z = 280;


    var VideoModal = function(title = "", description = "", url="") {
      this.element = document.getElementById('videoModal');
      this.videoModal = new bootstrap.Modal(this.element, {});

      this.title = this.element.getElementsByClassName('modal-title')[0];
      this.title.innerHTML = title;

      this.body = this.element.getElementsByClassName('modal-body')[0];
      this.description = this.body.getElementsByClassName('description')[0];
      this.description.innerHTML = description;

      this.video = this.body.getElementsByTagName('video')[0];
      this.source = this.video.getElementsByTagName('source')[0];
      this.source.setAttribute('src', url);

      this.visible = this.element.classList.contains('show');

      VideoModal.prototype.hide = function() {
        if(this.visible) {
          this.videoModal.hide();
          this.video.pause();
          this.visible = false;
        }
      }

      VideoModal.prototype.show = function() {
        if(!this.visible) {
          this.videoModal.show();
          this.video.load();
          this.video.play();
          this.visible = true;
        }
      }

      VideoModal.prototype.setTitle = function(title) {
        this.title.innerHTML = title;
      }

      VideoModal.prototype.setBody = function(description) {
        this.description.innerHTML = description;
      }

      VideoModal.prototype.setVideoUrl = function(url) {
        this.source.setAttribute('src', url);
      }
    }

    document.onkeydown = checkKey;
    function animatePosition(targetAngle, speed, onUpdate, onComplete) {
      let position = { angle: 0.0 };
      let tween = new TWEEN.Tween(position)
        .easing(TWEEN.Easing.Cubic.InOut)
        .to({ angle: targetAngle }, speed)
        .start();

      tween.onUpdate(function(){
        onUpdate(position.angle);
      }).onComplete(onComplete);
    }
    function animateScale(currentScale, targetScale, speed, onUpdate, onComplete) {
      let scale = Object.assign(currentScale);
      let tween = new TWEEN.Tween(scale)
        .easing(TWEEN.Easing.Cubic.InOut)
        .to(targetScale, speed)
        .start();

      tween.onUpdate(function(){
        onUpdate(scale);
      }).onComplete(onComplete);
    }

    function triggerPinUnfocus() {
      const rootLayer = scene.children[0].children[0];
      const pointsLayer = rootLayer.children.filter(obj => obj.name == 'pointsLayer');
      const points = pointsLayer[0].children;
      for (let i=0;i<points.length; ++i) {
        animateScale(
          {pinScale: points[i].children[1].scale.x, glowScale: points[i].children[2].scale.x},
          {pinScale: 1, glowScale: 1.2},
        800, function(scalar) {
          points[i].children[1].scale.setScalar(scalar.pinScale);
          points[i].children[2].scale.setScalar(scalar.glowScale);
        }, function() {
          
        });
      }
    }
    var currentPoint;
    function triggerPinFocus() {
      currentPoint = null;
      const rootLayer = scene.children[0].children[0];
      const pointsLayer = rootLayer.children.filter(obj => obj.name == 'pointsLayer');
      const points = pointsLayer[0].children;
      var nearestDistance = Number.MAX_SAFE_INTEGER;
      for (let i=0;i<points.length; ++i) {
        var target = new THREE.Vector3();
        points[i].getWorldPosition(target);
        const distance = camera.position.distanceTo(target);
        if (distance < nearestDistance && distance < 197) {
          nearestDistance = distance;
          currentPoint = points[i];
        }
      }
      // console.log(nearestDistance);
      if (currentPoint) {
        animateScale(
          {pinScale: currentPoint.children[1].scale.x, glowScale: currentPoint.children[2].scale.x},
          {pinScale: 2, glowScale: 2.4}, 800, function(scalar) {
            currentPoint.children[1].scale.setScalar(scalar.pinScale);
            currentPoint.children[2].scale.setScalar(scalar.glowScale);
        });
      }
    }
    var modal;
    function checkKey(e) {
        e = e || window.event;
        const currentPosition = { ...camera.position };
        if(modal) {
          modal.hide();
        }
        if (e.keyCode == '38') {
            // up arrow
            triggerPinUnfocus();
            animatePosition(0.03, 500, function(angle) {
              if (scene.rotation.x < -1.5) return;
              scene.rotation.x -= angle;
            }, function() {
              triggerPinFocus();
            });
        }
        else if (e.keyCode == '40') {
            // down arrow
            triggerPinUnfocus();
            animatePosition(0.03, 500, function(angle) {
              if (scene.rotation.x > 1.5) return;
              scene.rotation.x += angle;
            }, function() {
              triggerPinFocus();
            });
        }
        else if (e.keyCode == '37') {
            // left arrow
            triggerPinUnfocus();
            animatePosition(0.04, 500, function(angle) {
              // if (currentPosition.z * Math.cos(angle) + currentPosition.y * Math.sin(angle) < 0) return;
              scene.rotation.y -= angle;
            }, function() {
              triggerPinFocus();
            });
        }
        else if (e.keyCode == '39') {
            // right arrow
            triggerPinUnfocus();
            animatePosition(0.04, 500, function(angle) {
              // if (currentPosition.z * Math.cos(angle) + currentPosition.y * Math.sin(angle) < 0) return;
              scene.rotation.y += angle;
            }, function() {
              triggerPinFocus();
            });
        }
        else if (e.keyCode == '13') {
          // enter key
          if (currentPoint) {
            modal = new VideoModal(currentPoint.__title, 
              currentPoint.__description, currentPoint.__url);
            modal.show();
          }
        }
    }

    // // Add camera controls
    // const tbControls = new THREE.TrackballControls(camera, renderer.domElement);
    // tbControls.minDistance = 101;
    // tbControls.rotateSpeed = 5;
    // tbControls.zoomSpeed = 0.8;

    // Kick-off renderer
    (function animate() { // IIFE
      // Frame cycle
      // tbControls.update();
      TWEEN.update();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    })();

    // Clock
    const timeElm = document.getElementById('time');
    const doc = document.documentElement;
    const { clientWidth, clientHeight } = doc;

    const pad = (val) => val < 10 ? `0${val}` : val;

    const animationFrame$ = Rx.Observable.interval(0, Rx.Scheduler.animationFrame);

    // 3 minutes countdown
    var seconds = 10800;
    const time$ = Rx.Observable
      .interval(1000)
      .map(() => {
        seconds = Math.max(0, seconds - 60);
        return {      
          minutes: Math.floor(seconds / 3600),
          seconds: (seconds % 3600) / 60,
        };
      })
      .subscribe(({ hours, minutes, seconds}) => {
        timeElm.setAttribute('data-hours', pad(minutes));
        timeElm.setAttribute('data-minutes', pad(seconds));
      });
  </script>
</body>